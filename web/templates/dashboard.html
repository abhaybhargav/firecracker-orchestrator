{{define "content"}}
<div x-data="dashboard()" x-init="init()">
    <!-- Page Header -->
    <div class="px-4 py-6 sm:px-0">
        <div class="border-4 border-dashed border-gray-200 rounded-lg p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Dashboard</h2>
            
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
                <!-- Total VMs -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-server text-gray-400 text-2xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total VMs</dt>
                                    <dd class="text-lg font-medium text-gray-900" x-text="stats.totalVMs">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Running VMs -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-play text-green-400 text-2xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Running VMs</dt>
                                    <dd class="text-lg font-medium text-gray-900" x-text="stats.runningVMs">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Containers -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-box text-gray-400 text-2xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Containers</dt>
                                    <dd class="text-lg font-medium text-gray-900" x-text="stats.totalContainers">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Running Containers -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-play text-blue-400 text-2xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Running Containers</dt>
                                    <dd class="text-lg font-medium text-gray-900" x-text="stats.runningContainers">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="mt-8">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Recent VMs</h3>
                <div class="bg-white shadow overflow-hidden sm:rounded-md">
                    <ul class="divide-y divide-gray-200" x-show="recentVMs.length > 0">
                        <template x-for="vm in recentVMs" :key="vm.id">
                            <li>
                                <div class="px-4 py-4 flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                                <i class="fas fa-server text-gray-600"></i>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900" x-text="vm.name"></div>
                                            <div class="text-sm text-gray-500">
                                                <span x-text="vm.memory"></span>MB RAM, 
                                                <span x-text="vm.cpus"></span> CPU(s)
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <span :class="getStatusClass(vm.status)" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" x-text="vm.status"></span>
                                        <div class="ml-2 flex-shrink-0 flex">
                                            <button @click="viewVM(vm.id)" class="bg-white rounded-md text-sm text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </template>
                    </ul>
                    <div x-show="recentVMs.length === 0" class="text-center py-12">
                        <i class="fas fa-server text-gray-300 text-4xl mb-4"></i>
                        <p class="text-gray-500">No VMs created yet</p>
                        <a href="/vms" class="mt-2 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-orange-600 bg-orange-100 hover:bg-orange-200">
                            Create your first VM
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="mt-8">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div @click="createVM()" class="cursor-pointer relative rounded-lg border border-gray-300 bg-white px-6 py-5 shadow-sm flex items-center space-x-3 hover:border-gray-400 focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-orange-500">
                        <div class="flex-shrink-0">
                            <i class="fas fa-plus text-orange-500 text-xl"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900">Create New VM</p>
                            <p class="text-sm text-gray-500">Launch a new Firecracker virtual machine</p>
                        </div>
                    </div>

                    <div @click="createContainer()" class="cursor-pointer relative rounded-lg border border-gray-300 bg-white px-6 py-5 shadow-sm flex items-center space-x-3 hover:border-gray-400 focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-orange-500">
                        <div class="flex-shrink-0">
                            <i class="fas fa-rocket text-blue-500 text-xl"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900">Deploy Container</p>
                            <p class="text-sm text-gray-500">Deploy a new container to a VM</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick VM Creation Modal -->
    <div x-show="showCreateVMModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Create New VM</h3>
                    <button @click="showCreateVMModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form @submit.prevent="submitCreateVM()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">VM Name</label>
                        <input x-model="newVM.name" type="text" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                               placeholder="my-vm">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Memory (MB)</label>
                            <input x-model="newVM.memory" type="number" min="128" max="8192" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                   placeholder="512">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CPUs</label>
                            <input x-model="newVM.cpus" type="number" min="1" max="8" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                   placeholder="1">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" @click="showCreateVMModal = false" 
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" :disabled="createLoading"
                                class="px-4 py-2 text-sm font-medium text-white bg-orange-600 border border-transparent rounded-md hover:bg-orange-700 disabled:opacity-50">
                            <span x-show="!createLoading">Create VM</span>
                            <span x-show="createLoading"><i class="fas fa-spinner fa-spin mr-2"></i>Creating...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function dashboard() {
    return {
        stats: {
            totalVMs: 0,
            runningVMs: 0,
            totalContainers: 0,
            runningContainers: 0
        },
        recentVMs: [],
        showCreateVMModal: false,
        createLoading: false,
        newVM: {
            name: '',
            memory: 512,
            cpus: 1
        },
        
        init() {
            this.loadStats();
            this.loadRecentVMs();
        },
        
        async loadStats() {
            try {
                const response = await fetch('/api/v1/stats');
                const data = await response.json();
                this.stats = data;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        },
        
        async loadRecentVMs() {
            try {
                const response = await fetch('/api/v1/vms?limit=5');
                const data = await response.json();
                this.recentVMs = data || [];
            } catch (error) {
                console.error('Failed to load recent VMs:', error);
            }
        },
        
        createVM() {
            this.showCreateVMModal = true;
        },
        
        createContainer() {
            window.location.href = '/containers/new';
        },
        
        async submitCreateVM() {
            if (!this.newVM.name.trim()) {
                showToast('Please enter a VM name', 'error');
                return;
            }
            
            this.createLoading = true;
            
            try {
                const response = await fetch('/api/v1/vms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(this.newVM)
                });
                
                if (response.ok) {
                    showToast('VM created successfully', 'success');
                    this.showCreateVMModal = false;
                    this.newVM = { name: '', memory: 512, cpus: 1 };
                    this.loadStats();
                    this.loadRecentVMs();
                } else {
                    const error = await response.text();
                    showToast(`Failed to create VM: ${error}`, 'error');
                }
            } catch (error) {
                console.error('Failed to create VM:', error);
                showToast('Failed to create VM', 'error');
            } finally {
                this.createLoading = false;
            }
        },
        
        getStatusClass(status) {
            switch (status) {
                case 'running':
                    return 'bg-green-100 text-green-800';
                case 'stopped':
                    return 'bg-gray-100 text-gray-800';
                case 'creating':
                    return 'bg-yellow-100 text-yellow-800';
                case 'error':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        },
        
        viewVM(vmId) {
            window.location.href = `/vms/${vmId}`;
        }
    }
}
</script>

<style>
[x-cloak] { display: none !important; }
</style>
{{end}}